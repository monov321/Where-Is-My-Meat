<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>where is my meat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #0a1525;
      --card: #0f1e32;
      --card-hover: #142842;
      --muted: #8a9bb0;
      --accent: #ff6b35;
      --accent-2: #f79e1b;
      --accent-gradient: linear-gradient(135deg, var(--accent), var(--accent-2));
      --radius: 16px;
      --soft: #e8f1ff;
      --success: #2ecc71;
      --warning: #f39c12;
      --error: #e74c3c;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--soft);
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(255, 107, 53, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(247, 158, 27, 0.1) 0%, transparent 20%);
    }

    .topbar {
      padding: 20px 30px;
      background: rgba(10, 21, 37, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo-container {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--accent-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
    }

    .logo-icon {
      font-size: 30px;
      color: white;
    }

    .brand-text h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .brand-text .tag {
      margin: 5px 0 0;
      font-size: 14px;
      color: var(--muted);
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      padding: 25px;
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: var(--shadow);
      transition: var(--transition);
      height: fit-content;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
    }

    .card h2 {
      margin-top: 0;
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--soft);
    }

    .card h2 i {
      color: var(--accent);
    }

    .btn {
      background: var(--accent-gradient);
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 15px;
      font-size: 16px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
    }

    .btn.ghost {
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.15);
      color: var(--soft);
      box-shadow: none;
    }

    .btn.ghost:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--accent);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn:disabled:hover {
      transform: none;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--soft);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: var(--accent);
    }

    .dropzone {
      border: 2px dashed rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      text-align: center;
      padding: 40px 20px;
      cursor: pointer;
      color: var(--muted);
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .dropzone:hover {
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.02);
    }

    .dropzone.dragover {
      border-color: var(--accent);
      background: rgba(255, 107, 53, 0.05);
    }

    .dropzone i {
      font-size: 40px;
      color: var(--muted);
    }

    .dropzone.dragover i {
      color: var(--accent);
    }

    .or {
      text-align: center;
      margin: 20px 0;
      color: var(--muted);
      position: relative;
    }

    .or:before, .or:after {
      content: "";
      position: absolute;
      top: 50%;
      width: 45%;
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
    }

    .or:before {
      left: 0;
    }

    .or:after {
      right: 0;
    }

    .camera-container {
      position: relative;
      margin-top: 15px;
      text-align: center;
    }

    video {
      width: 100%;
      max-width: 500px;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      background: #000;
    }

    .capture-preview {
      width: 100%;
      max-width: 500px;
      border-radius: 12px;
      border: 2px solid var(--accent);
      display: none;
    }

    .scan-overlay {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 500px;
      height: 100%;
      pointer-events: none;
      border: 3px solid var(--accent);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
    }

    .scan-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 70%;
      border: 2px solid var(--accent);
      border-radius: 8px;
      background: rgba(255, 107, 53, 0.1);
    }

    .scan-line {
      position: absolute;
      height: 3px;
      width: 100%;
      background: var(--accent);
      top: 0;
      animation: scan 2s infinite ease-in-out;
      box-shadow: 0 0 10px var(--accent);
    }

    @keyframes scan {
      0% { top: 0; }
      100% { top: 100%; }
    }

    .camera-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .camera-controls .btn {
      margin-top: 0;
      flex: 1;
      min-width: 140px;
      max-width: 200px;
    }

    .capture-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--accent-gradient);
      border: 4px solid white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 15px auto;
      box-shadow: 0 4px 20px rgba(255, 107, 53, 0.4);
      transition: var(--transition);
    }

    .capture-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 25px rgba(255, 107, 53, 0.6);
    }

    .capture-btn:active {
      transform: scale(0.95);
    }

    .capture-btn i {
      color: white;
      font-size: 24px;
    }

    .ficha {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 25px;
      transition: var(--transition);
      min-height: 200px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .ficha.empty {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ficha.empty .placeholder {
      color: var(--muted);
      text-align: center;
      font-size: 16px;
    }

    .ficha-content p {
      margin: 12px 0;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
    }

    .ficha-content p:last-child {
      border-bottom: none;
    }

    .ficha-content strong {
      min-width: 200px;
      display: inline-block;
      color: var(--muted);
    }

    .footer {
      text-align: center;
      color: var(--muted);
      padding: 20px;
      font-size: 14px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      margin-top: 30px;
    }

    .scanning-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
      color: var(--accent);
      font-size: 14px;
    }

    .pulse {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.9);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.7;
      }
      100% {
        transform: scale(0.9);
        opacity: 1;
      }
    }

    .success-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: rgba(46, 204, 113, 0.2);
      color: var(--success);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      margin-left: 10px;
    }

    .status-message {
      padding: 12px 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-success {
      background: rgba(46, 204, 113, 0.1);
      color: var(--success);
      border: 1px solid rgba(46, 204, 113, 0.3);
    }

    .status-warning {
      background: rgba(243, 156, 18, 0.1);
      color: var(--warning);
      border: 1px solid rgba(243, 156, 18, 0.3);
    }

    .status-error {
      background: rgba(231, 76, 60, 0.1);
      color: var(--error);
      border: 1px solid rgba(231, 76, 60, 0.3);
    }

    .status-info {
      background: rgba(52, 152, 219, 0.1);
      color: #3498db;
      border: 1px solid rgba(52, 152, 219, 0.3);
    }

    .instruction {
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      margin: 10px 0;
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
        padding: 20px;
      }
      
      .topbar {
        padding: 15px 20px;
      }
      
      .brand {
        gap: 15px;
      }
      
      .logo-container {
        width: 50px;
        height: 50px;
      }
      
      .logo-icon {
        font-size: 22px;
      }
      
      .brand-text h1 {
        font-size: 20px;
      }

      .camera-controls {
        flex-direction: column;
        align-items: center;
      }

      .camera-controls .btn {
        max-width: 100%;
      }

      video, .capture-preview {
        max-width: 100%;
      }
    }
  </style>
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo-container">
        <i class="fas fa-qrcode logo-icon"></i>
      </div>
      <div class="brand-text">
        <h1>where is my meat</h1>
        <p class="tag">Â¡Conoce mÃ¡s a fondo sobre la carne que compras!</p>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2><i class="fas fa-camera"></i> Escanear cÃ³digo QR</h2>
      
      <input id="fileInput" type="file" accept="image/*" hidden />
      <div class="dropzone" id="dropzone">
        <i class="fas fa-cloud-upload-alt"></i>
        <div>Arrastra una imagen aquÃ­ o haz clic para seleccionar</div>
        <small>Formatos soportados: JPG, PNG, GIF</small>
      </div>

      <div class="or">o</div>

      <button id="startCamera" class="btn">
        <i class="fas fa-video"></i> Activar CÃ¡mara
      </button>

      <div id="cameraSection" style="display: none;">
        <div class="instruction">
          <i class="fas fa-info-circle"></i> Enfoca el cÃ³digo QR y toma una foto
        </div>
        
        <div class="camera-container">
          <video id="video" autoplay playsinline></video>
          <canvas id="videoCanvas" style="display: none;"></canvas>
          
          <div class="scan-overlay">
            <div class="scan-frame">
              <div class="scan-line"></div>
            </div>
          </div>

          <div class="capture-btn" id="captureBtn">
            <i class="fas fa-camera"></i>
          </div>

          <img id="capturePreview" class="capture-preview" alt="Vista previa">
        </div>

        <div class="camera-controls">
          <button id="retakeBtn" class="btn btn-secondary" style="display: none;">
            <i class="fas fa-redo"></i> Volver a Tomar
          </button>
          <button id="switchCamera" class="btn btn-secondary">
            <i class="fas fa-sync-alt"></i> Cambiar CÃ¡mara
          </button>
          <button id="stopCamera" class="btn ghost">
            <i class="fas fa-times"></i> Cerrar CÃ¡mara
          </button>
        </div>

        <div id="scanningIndicator" class="scanning-indicator">
          <div class="pulse"></div>
          Procesando imagen...
        </div>
      </div>

      <div id="statusMessage"></div>
    </section>

    <section class="card">
      <h2><i class="fas fa-info-circle"></i> Datos de la carne</h2>
      <div id="ficha" class="ficha empty">
        <div class="placeholder">
          <i class="fas fa-barcode" style="font-size: 40px; margin-bottom: 15px; display: block;"></i>
          Los datos del producto aparecerÃ¡n aquÃ­ despuÃ©s de escanear el cÃ³digo QR
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <p>where is my meat &copy; 2025</p>
  </footer>

  <script>
    // Elementos DOM
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const ficha = document.getElementById("ficha");
    const statusMessage = document.getElementById("statusMessage");
    const cameraSection = document.getElementById("cameraSection");
    const video = document.getElementById("video");
    const videoCanvas = document.getElementById("videoCanvas");
    const captureBtn = document.getElementById("captureBtn");
    const capturePreview = document.getElementById("capturePreview");
    const retakeBtn = document.getElementById("retakeBtn");
    const scanningIndicator = document.getElementById("scanningIndicator");

    const startCamera = document.getElementById("startCamera");
    const stopCamera = document.getElementById("stopCamera");
    const switchCamera = document.getElementById("switchCamera");

    const vctx = videoCanvas.getContext("2d");

    // Variables de estado
    let camStream = null;
    let currentFacingMode = 'environment';
    let isCameraActive = false;

    // Mostrar mensaje de estado
    function showStatus(message, type = 'info') {
      const types = {
        success: 'status-success',
        warning: 'status-warning',
        error: 'status-error',
        info: 'status-info'
      };
      
      statusMessage.innerHTML = `
        <div class="status-message ${types[type] || 'status-info'}">
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i>
          ${message}
        </div>
      `;
    }

    function clearStatus() {
      statusMessage.innerHTML = '';
    }

    // Mostrar datos del QR
    function showData(raw) {
      ficha.innerHTML = "";
      ficha.classList.remove("empty");

      try {
        const json = JSON.parse(raw);
        ficha.innerHTML = `
          <div class="ficha-content">
            <p><strong>Empresa:</strong> ${json.empresa_de_la_carne || "â€”"} <span class="success-badge"><i class="fas fa-check"></i> Verificado</span></p>
            <p><strong>Tipo de carne:</strong> ${json.tipo_carne || "â€”"}</p>
            <p><strong>Fecha de matar:</strong> ${json.fecha_matar || "â€”"}</p>
            <p><strong>Entrada establecimiento:</strong> ${json.fecha_entrada_establecimiento || "â€”"}</p>
            <p><strong>Fecha caducidad:</strong> ${json.fecha_caducidad || "â€”"}</p>
            <p><strong>Corte:</strong> ${json.corte || "â€”"}</p>
            ${json.peso_kg ? `<p><strong>Peso:</strong> ${json.peso_kg} kg</p>` : ''}
            ${json.lote ? `<p><strong>Lote:</strong> ${json.lote}</p>` : ''}
            ${json.calidad ? `<p><strong>Calidad:</strong> ${json.calidad}</p>` : ''}
            ${json.origen ? `<p><strong>Origen:</strong> ${json.origen}</p>` : ''}
          </div>
        `;
        
        showStatus('âœ… CÃ³digo QR escaneado correctamente', 'success');
        
      } catch (error) {
        ficha.innerHTML = `
          <div class="ficha-content">
            <p><strong>Contenido del QR:</strong></p>
            <pre style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; overflow: auto; max-height: 200px;">${raw}</pre>
          </div>
        `;
        showStatus('âš ï¸ QR escaneado pero formato no reconocido', 'warning');
      }
    }

    // Decodificar QR
    function decode(imageData) {
      try {
        const qr = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (qr) {
          showData(qr.data);
          return true;
        }
        return false;
      } catch (error) {
        console.error('Error en decodificaciÃ³n:', error);
        return false;
      }
    }

    // Subida de archivos
    dropzone.addEventListener("click", () => fileInput.click());

    dropzone.addEventListener("dragover", e => {
      e.preventDefault();
      dropzone.classList.add("dragover");
    });

    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));

    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      const files = [...e.dataTransfer.files].filter(file => file.type.startsWith('image/'));
      if (files.length > 0) {
        loadFile(files[0]);
      } else {
        showStatus('âš ï¸ Por favor, arrastra solo archivos de imagen', 'error');
      }
    });

    fileInput.addEventListener("change", e => {
      if (e.target.files.length > 0) {
        loadFile(e.target.files[0]);
      }
    });

    function loadFile(file) {
      if (!file.type.startsWith('image/')) {
        showStatus('âš ï¸ Por favor, selecciona un archivo de imagen vÃ¡lido', 'error');
        return;
      }

      const img = new Image();
      img.onload = () => {
        clearStatus();
        scanningIndicator.style.display = 'flex';
        
        // Crear canvas temporal para procesar la imagen
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        setTimeout(() => {
          if (!decode(imageData)) {
            showStatus('âš ï¸ No se detectÃ³ un cÃ³digo QR vÃ¡lido en la imagen', 'error');
          }
          scanningIndicator.style.display = 'none';
        }, 500);
      };
      img.onerror = () => {
        showStatus('âŒ Error al cargar la imagen', 'error');
        scanningIndicator.style.display = 'none';
      };
      img.src = URL.createObjectURL(file);
    }

    // Funciones de cÃ¡mara
    async function getCameraStream(facingMode = 'environment') {
      const constraints = {
        video: {
          facingMode: facingMode,
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      };

      try {
        return await navigator.mediaDevices.getUserMedia(constraints);
      } catch (error) {
        // Fallback a configuraciÃ³n bÃ¡sica
        const fallbackConstraints = { video: { facingMode: facingMode } };
        return await navigator.mediaDevices.getUserMedia(fallbackConstraints);
      }
    }

    async function startCam() {
      try {
        showStatus('ðŸ”„ Activando cÃ¡mara...', 'info');
        startCamera.disabled = true;

        camStream = await getCameraStream(currentFacingMode);
        
        video.srcObject = camStream;
        cameraSection.style.display = 'block';
        scanningIndicator.style.display = 'none';
        
        startCamera.style.display = 'none';
        isCameraActive = true;

        // Esperar a que el video estÃ© listo
        await new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.play().then(resolve);
          };
        });

        showStatus('âœ… CÃ¡mara activada. Enfoca el cÃ³digo QR y toma una foto.', 'success');
        
      } catch (err) {
        console.error('Error al iniciar cÃ¡mara:', err);
        showStatus(`âŒ No se pudo acceder a la cÃ¡mara: ${err.message}`, 'error');
        startCamera.disabled = false;
      }
    }

    function stopCam() {
      if (camStream) {
        camStream.getTracks().forEach(track => track.stop());
        camStream = null;
      }
      
      cameraSection.style.display = 'none';
      startCamera.style.display = 'block';
      startCamera.disabled = false;
      capturePreview.style.display = 'none';
      video.style.display = 'block';
      retakeBtn.style.display = 'none';
      captureBtn.style.display = 'flex';
      isCameraActive = false;
      
      clearStatus();
    }

    async function switchCameraFn() {
      if (!camStream) return;
      
      stopCam();
      currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
      
      // PequeÃ±o delay para permitir que la cÃ¡mara anterior se libere
      await new Promise(resolve => setTimeout(resolve, 500));
      startCam();
    }

    // Capturar foto
    function capturePhoto() {
      if (!isCameraActive) return;

      // Configurar canvas con las dimensiones del video
      videoCanvas.width = video.videoWidth;
      videoCanvas.height = video.videoHeight;
      vctx.drawImage(video, 0, 0, videoCanvas.width, videoCanvas.height);
      
      // Mostrar vista previa
      capturePreview.src = videoCanvas.toDataURL('image/png');
      capturePreview.style.display = 'block';
      video.style.display = 'none';
      retakeBtn.style.display = 'block';
      captureBtn.style.display = 'none';
      
      // Procesar la imagen capturada
      processCapturedImage();
    }

    function processCapturedImage() {
      scanningIndicator.style.display = 'flex';
      showStatus('ðŸ” Procesando imagen...', 'info');

      setTimeout(() => {
        try {
          const imageData = vctx.getImageData(0, 0, videoCanvas.width, videoCanvas.height);
          
          if (decode(imageData)) {
            // Ã‰xito - el QR fue decodificado y mostrado en showData()
          } else {
            showStatus('âŒ No se detectÃ³ un cÃ³digo QR en la foto. Intenta de nuevo.', 'error');
            retakePhoto();
          }
        } catch (error) {
          showStatus('âŒ Error al procesar la imagen', 'error');
          retakePhoto();
        } finally {
          scanningIndicator.style.display = 'none';
        }
      }, 1000);
    }

    function retakePhoto() {
      capturePreview.style.display = 'none';
      video.style.display = 'block';
      retakeBtn.style.display = 'none';
      captureBtn.style.display = 'flex';
      clearStatus();
    }

    // Event listeners
    startCamera.addEventListener("click", startCam);
    stopCamera.addEventListener("click", stopCam);
    switchCamera.addEventListener("click", switchCameraFn);
    captureBtn.addEventListener("click", capturePhoto);
    retakeBtn.addEventListener("click", retakePhoto);

    // Limpieza al cerrar la pÃ¡gina
    window.addEventListener('beforeunload', () => {
      if (camStream) {
        camStream.getTracks().forEach(track => track.stop());
      }
    });

    // Mensaje inicial
    showStatus('ðŸ‘† Selecciona una imagen o activa la cÃ¡mara para escanear un cÃ³digo QR', 'info');

  </script>
</body>
</html>
