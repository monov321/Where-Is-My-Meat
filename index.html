<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>where is my meat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #0a1525;
      --card: #0f1e32;
      --card-hover: #142842;
      --muted: #8a9bb0;
      --accent: #ff6b35;
      --accent-2: #f79e1b;
      --accent-gradient: linear-gradient(135deg, var(--accent), var(--accent-2));
      --radius: 16px;
      --soft: #e8f1ff;
      --success: #2ecc71;
      --warning: #f39c12;
      --error: #e74c3c;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--soft);
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(255, 107, 53, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(247, 158, 27, 0.1) 0%, transparent 20%);
    }

    .topbar {
      padding: 20px 30px;
      background: rgba(10, 21, 37, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo-container {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--accent-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
    }

    .logo-icon {
      font-size: 30px;
      color: white;
    }

    .brand-text h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .brand-text .tag {
      margin: 5px 0 0;
      font-size: 14px;
      color: var(--muted);
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      padding: 25px;
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: var(--shadow);
      transition: var(--transition);
      height: fit-content;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
    }

    .card h2 {
      margin-top: 0;
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--soft);
    }

    .card h2 i {
      color: var(--accent);
    }

    .btn {
      background: var(--accent-gradient);
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 15px;
      font-size: 16px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
    }

    .btn.ghost {
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.15);
      color: var(--soft);
      box-shadow: none;
    }

    .btn.ghost:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--accent);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn:disabled:hover {
      transform: none;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
    }

    .dropzone {
      border: 2px dashed rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      text-align: center;
      padding: 40px 20px;
      cursor: pointer;
      color: var(--muted);
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .dropzone:hover {
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.02);
    }

    .dropzone.dragover {
      border-color: var(--accent);
      background: rgba(255, 107, 53, 0.05);
    }

    .dropzone i {
      font-size: 40px;
      color: var(--muted);
    }

    .dropzone.dragover i {
      color: var(--accent);
    }

    .or {
      text-align: center;
      margin: 20px 0;
      color: var(--muted);
      position: relative;
    }

    .or:before, .or:after {
      content: "";
      position: absolute;
      top: 50%;
      width: 45%;
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
    }

    .or:before {
      left: 0;
    }

    .or:after {
      right: 0;
    }

    .camera-container {
      position: relative;
      margin-top: 15px;
    }

    video {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: #000;
    }

    .scan-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      border: 2px solid var(--accent);
      border-radius: 12px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    }

    .scan-line {
      position: absolute;
      height: 3px;
      width: 100%;
      background: var(--accent);
      top: 50%;
      animation: scan 2s infinite linear;
      box-shadow: 0 0 10px var(--accent);
    }

    @keyframes scan {
      0%, 100% { top: 20%; }
      50% { top: 80%; }
    }

    .ficha {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 25px;
      transition: var(--transition);
      min-height: 200px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .ficha.empty {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ficha.empty .placeholder {
      color: var(--muted);
      text-align: center;
      font-size: 16px;
    }

    .ficha-content p {
      margin: 12px 0;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
    }

    .ficha-content p:last-child {
      border-bottom: none;
    }

    .ficha-content strong {
      min-width: 200px;
      display: inline-block;
      color: var(--muted);
    }

    .footer {
      text-align: center;
      color: var(--muted);
      padding: 20px;
      font-size: 14px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      margin-top: 30px;
    }

    .scanning-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      color: var(--accent);
      font-size: 14px;
    }

    .pulse {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.9);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.7;
      }
      100% {
        transform: scale(0.9);
        opacity: 1;
      }
    }

    .success-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: rgba(46, 204, 113, 0.2);
      color: var(--success);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      margin-left: 10px;
    }

    .status-message {
      padding: 10px 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-success {
      background: rgba(46, 204, 113, 0.1);
      color: var(--success);
      border: 1px solid rgba(46, 204, 113, 0.3);
    }

    .status-warning {
      background: rgba(243, 156, 18, 0.1);
      color: var(--warning);
      border: 1px solid rgba(243, 156, 18, 0.3);
    }

    .status-error {
      background: rgba(231, 76, 60, 0.1);
      color: var(--error);
      border: 1px solid rgba(231, 76, 60, 0.3);
    }

    .camera-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .camera-controls .btn {
      margin-top: 0;
      flex: 1;
    }

    .performance-info {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
        padding: 20px;
      }
      
      .topbar {
        padding: 15px 20px;
      }
      
      .brand {
        gap: 15px;
      }
      
      .logo-container {
        width: 50px;
        height: 50px;
      }
      
      .logo-icon {
        font-size: 22px;
      }
      
      .brand-text h1 {
        font-size: 20px;
      }

      .camera-controls {
        flex-direction: column;
      }
    }
  </style>
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo-container">
        <i class="fas fa-qrcode logo-icon"></i>
      </div>
      <div class="brand-text">
        <h1>where is my meat</h1>
        <p class="tag">¬°Conoce m√°s a fondo sobre la carne que compras!</p>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2><i class="fas fa-camera"></i> Escanear c√≥digo QR</h2>
      
      <input id="fileInput" type="file" accept="image/*" hidden />
      <div class="dropzone" id="dropzone">
        <i class="fas fa-cloud-upload-alt"></i>
        <div>Arrastra una imagen aqu√≠ o haz clic para seleccionar</div>
        <small>Formatos soportados: JPG, PNG, GIF</small>
      </div>

      <div class="or">o</div>

      <button id="startCamera" class="btn">
        <i class="fas fa-video"></i> Usar c√°mara
      </button>

      <div id="cameraContainer" class="camera-container" hidden>
        <video id="video" autoplay playsinline></video>
        <div class="scan-overlay" hidden>
          <div class="scan-line"></div>
        </div>
        <canvas id="videoCanvas" hidden></canvas>
        
        <div class="camera-controls">
          <button id="switchCamera" class="btn ghost" hidden>
            <i class="fas fa-sync-alt"></i> Cambiar c√°mara
          </button>
          <button id="stopCamera" class="btn ghost">
            <i class="fas fa-stop"></i> Detener c√°mara
          </button>
        </div>
      </div>

      <div id="scanningIndicator" class="scanning-indicator" hidden>
        <div class="pulse"></div>
        Escaneando en tiempo real...
      </div>

      <div id="statusMessage"></div>
      <div class="performance-info" id="performanceInfo"></div>
    </section>

    <section class="card">
      <h2><i class="fas fa-info-circle"></i> Datos de la carne</h2>
      <div id="ficha" class="ficha empty">
        <div class="placeholder">
          <i class="fas fa-barcode" style="font-size: 40px; margin-bottom: 15px; display: block;"></i>
          Los datos del producto aparecer√°n aqu√≠ despu√©s de escanear el c√≥digo QR
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <p>where is my meat &copy; 2025</p>
  </footer>

  <script>
    // Elementos DOM
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const ficha = document.getElementById("ficha");
    const scanningIndicator = document.getElementById("scanningIndicator");
    const statusMessage = document.getElementById("statusMessage");
    const performanceInfo = document.getElementById("performanceInfo");
    const cameraContainer = document.getElementById("cameraContainer");

    const startCamera = document.getElementById("startCamera");
    const stopCamera = document.getElementById("stopCamera");
    const switchCamera = document.getElementById("switchCamera");
    const video = document.getElementById("video");
    const videoCanvas = document.getElementById("videoCanvas");
    const scanOverlay = document.querySelector('.scan-overlay');
    const vctx = videoCanvas.getContext("2d");

    // Variables de estado
    let camStream = null;
    let scanLoop = null;
    let currentFacingMode = 'environment';
    let lastScanTime = 0;
    let scanCount = 0;
    let successCount = 0;
    let isScanning = false;

    // Configuraci√≥n de rendimiento
    const SCAN_INTERVAL = 300; // ms entre escaneos
    const MAX_SCAN_TIME = 10000; // 10 segundos m√°ximo de escaneo continuo
    const PERFORMANCE_THRESHOLD = 16; // ms por frame m√°ximo

    function showStatus(message, type = 'info') {
      const types = {
        success: 'status-success',
        warning: 'status-warning',
        error: 'status-error'
      };
      
      statusMessage.innerHTML = `
        <div class="status-message ${types[type] || 'status-warning'}">
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
          ${message}
        </div>
      `;
    }

    function clearStatus() {
      statusMessage.innerHTML = '';
    }

    function updatePerformanceInfo(scanTime) {
      const fps = scanTime > 0 ? Math.round(1000 / scanTime) : 0;
      const successRate = scanCount > 0 ? Math.round((successCount / scanCount) * 100) : 0;
      
      performanceInfo.innerHTML = `
        Escaneos: ${scanCount} | √âxitos: ${successRate}% | FPS: ${fps}
        ${scanTime > PERFORMANCE_THRESHOLD ? '‚ö†Ô∏è Rendimiento bajo' : '‚úÖ Rendimiento √≥ptimo'}
      `;
    }

    function showData(raw) {
      ficha.innerHTML = "";
      ficha.classList.remove("empty");

      try {
        const json = JSON.parse(raw);
        ficha.innerHTML = `
          <div class="ficha-content">
            <p><strong>Empresa:</strong> ${json.empresa_de_la_carne || "‚Äî"} <span class="success-badge"><i class="fas fa-check"></i> Verificado</span></p>
            <p><strong>Tipo de carne:</strong> ${json.tipo_carne || "‚Äî"}</p>
            <p><strong>Fecha de matar:</strong> ${json.fecha_matar || "‚Äî"}</p>
            <p><strong>Entrada establecimiento:</strong> ${json.fecha_entrada_establecimiento || "‚Äî"}</p>
            <p><strong>Fecha caducidad:</strong> ${json.fecha_caducidad || "‚Äî"}</p>
            <p><strong>Corte:</strong> ${json.corte || "‚Äî"}</p>
            ${json.peso_kg ? `<p><strong>Peso:</strong> ${json.peso_kg} kg</p>` : ''}
            ${json.lote ? `<p><strong>Lote:</strong> ${json.lote}</p>` : ''}
            ${json.calidad ? `<p><strong>Calidad:</strong> ${json.calidad}</p>` : ''}
          </div>
        `;
        
        showStatus('‚úÖ C√≥digo QR escaneado correctamente', 'success');
        stopCam(); // Detener c√°mara despu√©s de escanear exitosamente
        
      } catch (error) {
        ficha.innerHTML = `
          <div class="ficha-content">
            <p><strong>Contenido del QR:</strong></p>
            <pre style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; overflow: auto;">${raw}</pre>
          </div>
        `;
        showStatus('‚ö†Ô∏è QR escaneado pero formato no reconocido', 'warning');
      }
    }

    function decode(img) {
      const startTime = performance.now();
      
      try {
        const c = document.createElement("canvas");
        const ctx = c.getContext("2d");
        c.width = img.width;
        c.height = img.height;
        ctx.drawImage(img, 0, 0);
        const d = ctx.getImageData(0, 0, img.width, img.height);
        const qr = jsQR(d.data, img.width, img.height);
        
        scanCount++;
        const scanTime = performance.now() - startTime;
        
        if (qr) {
          successCount++;
          showData(qr.data);
          return true;
        }
        
        updatePerformanceInfo(scanTime);
        return false;
        
      } catch (error) {
        console.error('Error en decodificaci√≥n:', error);
        return false;
      }
    }

    // Eventos para subida de archivos
    dropzone.addEventListener("click", () => fileInput.click());

    dropzone.addEventListener("dragover", e => {
      e.preventDefault();
      dropzone.classList.add("dragover");
    });

    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));

    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      const files = [...e.dataTransfer.files].filter(file => file.type.startsWith('image/'));
      if (files.length > 0) {
        loadFile(files[0]);
      } else {
        showStatus('‚ö†Ô∏è Por favor, arrastra solo archivos de imagen', 'error');
      }
    });

    fileInput.addEventListener("change", e => {
      if (e.target.files.length > 0) {
        loadFile(e.target.files[0]);
      }
    });

    function loadFile(file) {
      if (!file.type.startsWith('image/')) {
        showStatus('‚ö†Ô∏è Por favor, selecciona un archivo de imagen v√°lido', 'error');
        return;
      }

      const img = new Image();
      img.onload = () => {
        clearStatus();
        if (!decode(img)) {
          showStatus('‚ö†Ô∏è No se detect√≥ un c√≥digo QR v√°lido en la imagen', 'error');
        }
      };
      img.onerror = () => {
        showStatus('‚ùå Error al cargar la imagen', 'error');
      };
      img.src = URL.createObjectURL(file);
    }

    // Funciones de c√°mara mejoradas
    async function getCameraStream(facingMode = 'environment') {
      const constraints = {
        video: {
          facingMode: facingMode,
          width: { ideal: 1280 },
          height: { ideal: 720 },
          frameRate: { ideal: 30 }
        }
      };

      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        return stream;
      } catch (error) {
        // Fallback a configuraci√≥n m√°s b√°sica
        const fallbackConstraints = {
          video: {
            facingMode: facingMode
          }
        };
        
        try {
          const stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
          return stream;
        } catch (fallbackError) {
          throw new Error(`No se pudo acceder a la c√°mara: ${fallbackError.message}`);
        }
      }
    }

    async function startCam() {
      try {
        showStatus('üîÑ Iniciando c√°mara...', 'warning');
        startCamera.disabled = true;

        camStream = await getCameraStream(currentFacingMode);
        
        video.srcObject = camStream;
        cameraContainer.hidden = false;
        scanningIndicator.hidden = false;
        scanOverlay.hidden = false;
        switchCamera.hidden = !isMobile() || !hasMultipleCameras();
        
        startCamera.hidden = true;
        clearStatus();

        // Esperar a que el video est√© listo
        await new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.play().then(resolve);
          };
        });

        startScanLoop();
        
      } catch (err) {
        console.error('Error al iniciar c√°mara:', err);
        showStatus(`‚ùå ${err.message}`, 'error');
        startCamera.disabled = false;
      }
    }

    function stopCam() {
      if (scanLoop) {
        cancelAnimationFrame(scanLoop);
        scanLoop = null;
      }
      
      if (camStream) {
        camStream.getTracks().forEach(track => track.stop());
        camStream = null;
      }
      
      cameraContainer.hidden = true;
      scanningIndicator.hidden = true;
      scanOverlay.hidden = true;
      startCamera.hidden = false;
      startCamera.disabled = false;
      isScanning = false;
      
      clearStatus();
      performanceInfo.innerHTML = '';
    }

    async function switchCameraFn() {
      if (!camStream) return;
      
      stopCam();
      currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
      
      // Peque√±o delay para permitir que la c√°mara anterior se libere
      await new Promise(resolve => setTimeout(resolve, 500));
      startCam();
    }

    function startScanLoop() {
      isScanning = true;
      lastScanTime = performance.now();
      scanCount = 0;
      successCount = 0;
      
      function scan() {
        if (!isScanning) return;
        
        const currentTime = performance.now();
        const timeSinceLastScan = currentTime - lastScanTime;
        
        // Control de frecuencia de escaneo para mejor rendimiento
        if (timeSinceLastScan >= SCAN_INTERVAL && video.readyState === video.HAVE_ENOUGH_DATA) {
          try {
            videoCanvas.width = video.videoWidth;
            videoCanvas.height = video.videoHeight;
            vctx.drawImage(video, 0, 0, videoCanvas.width, videoCanvas.height);
            
            const d = vctx.getImageData(0, 0, videoCanvas.width, videoCanvas.height);
            const qr = jsQR(d.data, videoCanvas.width, videoCanvas.height);
            
            if (qr) {
              showData(qr.data);
              return; // Salir del loop despu√©s de escanear exitosamente
            }
            
            lastScanTime = currentTime;
            
            // Timeout de seguridad
            if (currentTime - lastScanTime > MAX_SCAN_TIME) {
              showStatus('‚è∞ Tiempo de escaneo agotado. Intenta de nuevo.', 'warning');
              stopCam();
              return;
            }
            
          } catch (error) {
            console.error('Error en escaneo:', error);
          }
        }
        
        scanLoop = requestAnimationFrame(scan);
      }
      
      scanLoop = requestAnimationFrame(scan);
    }

    // Utilidades
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    async function hasMultipleCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        return videoDevices.length > 1;
      } catch {
        return false;
      }
    }

    // Event listeners
    startCamera.addEventListener("click", startCam);
    stopCamera.addEventListener("click", stopCam);
    switchCamera.addEventListener("click", switchCameraFn);

    // Limpieza al cerrar la p√°gina
    window.addEventListener('beforeunload', () => {
      stopCam();
    });

    // Manejo de visibilidad de p√°gina para optimizar rendimiento
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && isScanning) {
        cancelAnimationFrame(scanLoop);
      } else if (!document.hidden && isScanning && camStream) {
        startScanLoop();
      }
    });

    // Mensaje inicial de bienvenida
    showStatus('üëÜ Selecciona una imagen o usa la c√°mara para escanear un c√≥digo QR', 'warning');

  </script>
</body>
</html>
